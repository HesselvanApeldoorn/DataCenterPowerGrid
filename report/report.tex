%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[10pt]{article} % Default font size is 12pt, it can be changed here

\usepackage[margin=2.5cm]{geometry} % Required to change the page size to A4
\geometry{a4paper} % Set the page size to be A4 as opposed to the default US Letter

\usepackage{graphicx} % Required for including pictures

\usepackage[usenames,dvipsnames,svgnames,table]{xcolor} %colored text

\usepackage{tabularx} % Improved tabular*
\usepackage{tabulary} % Improved tabular*

\usepackage[colorlinks,linkcolor = {blue}]{hyperref} % Creation of links

\usepackage[toc,page]{appendix} % Easier creation of appendices

\usepackage{listings} % Improved listings

\usepackage{booktabs} % \toprule, \bottomrule, etc

\usepackage{float} % Allows putting an [H] in \begin{figure} to specify the exact location of the figure

\usepackage{wrapfig} % Allows in-line images such as the example fish picture

\usepackage{lipsum} % Used for inserting dummy 'Lorem ipsum' text into the template

\usepackage[square, numbers]{natbib} % Bibliography citation framework (in the style "[9]")

\linespread{1.2} % Line spacing

\setlength\parindent{0pt} % Uncomment to remove all indentation from paragraphs

\graphicspath{{Pictures/}} % Specifies the directory where pictures are stored

\usepackage{multirow} % Tabular multirows

\usepackage{rotating} % Rotating boxes

\usepackage{makecell} % Slash boxes

\usepackage{pdflscape} % Landscape pages for pfd (automatic rotation)

\usepackage{framed}
\hyphenpenalty 100000
\usepackage{eurosym}

\usepackage{perpage} %the perpage package
\MakePerPage{footnote} %the perpage package command

\usepackage[intoc]{nomencl} % The nomenclature package
\makenomenclature
\renewcommand{\nomname}{Glossary}

\usepackage{longtable}
\usepackage{ltxtable}

\usepackage{changepage} % Make indented paragraphs

\usepackage{todonotes} % Put ToDo's in the doc (creates a list as well) 

%----------------------------------------------------------------------------------------
% MACROS
%----------------------------------------------------------------------------------------

%textlabel
\makeatletter
\newcommand*{\textlabel}[2]{%
  \edef\@currentlabel{#1}% Set target label
  \phantomsection% Correct hyper reference link
  #1\label{#2}% Print and store label
}
\makeatother

% \newcommand{\hltext}[1]{\textcolor{red}{#1}} % To highlight text
\newcommand{\hltext}[1]{#1}

\newcommand{\stakeholder}[1]{%
	\stepcounter{stkh}% Add to counter
	\textlabel{SH-\ifnum\value{stkh}<10 0\fi\thestkh}{#1}% Create text to be referenced from desired label  
}

\newcolumntype{s}{>{\hsize=.25\hsize}X} % New column size for tabularx

%\renewcommand*{\lstlistingname}{Listing} % Change Prefix of the Listings, e.g., <name> 1. Caption 
\renewcommand*{\lstlistlistingname}{List of Listings} % Change Title of List of Listings

%\newcommand{\todo}[1]{(\textcolor{blue}{comment}\footnote{\textcolor{blue}{\bfseries ToDo: #1}})} % To make internal comments (to be removed in the deliverable)
%\newcommand{\comment}[1]{}

\title{\textsf{Distributed Systems | Power actions in a smart grid}}
\author{Bart Wiegmans \& Hessel van Apeldoorn}
\date{\today}

\begin{document}
\maketitle
\newpage
\section{Context/background}
Since the beginning of the 21st century the roles of energy suppliers has changed.  In the beginning the suppliers only delivered energy to their customers for a fixed tariff, which the energy suppliers produced when there was a demand for it. Since the emergence of natural energy production from sources such as the sun and wind, the energy suppliers have to deal with a production of energy even if there is no demand for it.  This results in a problem where the energy supplier gets stuck with an overproduction of energy.  This problem in combination with several other factors led to the development of the Smart Grid.
One of the features of a smart grid is an automatic load balancing based on production of energy. For example by shutting down or starting up a refrigerator in order to deal with the imbalance between production and consumption of energy on the grid.
An extra functionality it offers in combination with the balancing function here above is to stimulate balancing of the grid by offering discounts on the energy price in case of overproduction or higher prices in case of energy shortage. By doing this local energy users, as for example server farms, can decide to reduce or increase its usage and so saving money and reducing the imbalance on the grid.\\
 \\
A second change in technology since the beginning of the 21st century is the shift from local computing to cloud computing.  Today more and more services and software are placed in the cloud. The cloud is a general name for a large network of servers connected with each other through the Internet. By connecting a large group of server the storage, computing power and other resources of individual servers can be combined to process more complex task or balance multiple tasks over the servers that are idle at that moment.\\
\\
A smart grid also has to be present in a data center. The data center itself receives a steady stream of power that it has to split among the nodes in its grid. nodes are in general servers in the data center. A server may sometimes require less power and may sometimes require more. A server should always receive its required amount of power. In general, servers are not turned off and thus in total there should always be enough power for all servers.
\section{State of the Art}

Advanced metering infrastructure
Multicast  

\section{Problem statement}
Our program simulates a data center in which nodes communicate with each other to agree on the selling and distributing of power within the data center. Nodes have to be able to communicate with each other within a cluster group. All other nodes should be notified of these events. Broker nodes should be able to give client node the energy price. Client nodes in turn should be able to communicate  to the broker the amount of energy they require.\\
\\
Nodes are physically structured in clusters. Nodes may not always be on. Nodes should thus be able to dynamically join and leave a group. Furthermore, the brokers themselves also have a certain hierarchy. There is one lead broker which controls all other brokers. These brokers should be able to communicate with each other even though they are in different groups. \\
\\
There is the possibility that nodes, clients as well as brokers, fail. There should thus be a way to remove them properly. For clients this is not a big issue, since there are no other nodes that depend on clients. Brokers however have more responsibility as they serve the energy price to clients and control the infrastructure for a cluster of clients. Our program must thus have an election algorithm to determine what broker should take over when another broker fails.


% as more and more computing take place on servers it becomes interesting if tasks are cost efficient. are the costs lower than the potential revenue generated by it. 

\section{Relation to Distributed Systems}

Dynamic host discovery, server can be added or removed. 
Needs to be a broker, so a leader inside the system. 
Server must be ensured that they actually can bid and use energy, so reliable channels to the broker are important.

\section{Solution details}
In our project several algorithms and techniques have been used. In this section we try to give a better inside in where and how these techniques were used.
\subsection{IP multicast}
IP multicast is the most important communication technique in our project. IP multicast is used for sending messages within a group. It works as follows in our project: A process creates a message which it marks as a message to be sent by multicast. The message is then put into the output queue of this process. When the sender thread of this process has time to sent the message, it encodes the message and sends the message to the queue of the group to which the process belongs. Every client of this group can now grab and decode the message that has been sent.\\
\\
These are the steps necessary for basic multicasting. Our multicast should also be ordered and reliable. To achieve this we give a sequence number to each message that we want to sent. This gives us a way to check in what order we should receive messages. Furthermore, we introduce two new components: a resend buffer and a resend requester. The resend buffer stores two types of message: all sent (unicast or multicast) messages and all (sent or received) multicast messages. The resend requester gathers all messages that we expected to receive, but haven't received yet. Practically this means all messages that we expect to receive but can't find in the resend buffer. In the case of a multicast message, send the sender a request to resend the message. If the sender is dead, send a request to the entire group. In the case of a unicast message, send the sender a request. In case the sender has died, the receiver acts like the message has never existed. There are a few applications for multicast in our project:
\begin{itemize}
 \item \textbf{Sending of heartbeats:} The broker sends out heartbeats to all members within a group using multicast. When a member receives a heartbeatmessage, he will send back an acknowledgement message to the broker. This acknowledgement message is only send to the broker. As such, the technique used  to send back a message is unicast instead of multicast.\\
 \item \textbf{Removing a member:} Whenever a member is non-responsive (e.g. when no acknowledgements of heartbeats are received), a message is sent to all members of the group to inform that this member is leaving the group. These messages are sent using multicast.\\
 \item \textbf{Setting the energy price:} A broker sends a message with the energy price to all its client through multicast.\\
\end{itemize}
\subsection{Bully algorithm}
It is possible that a leader fails or crashes. This situation is handled by starting an election to pick a new leader. This election can be started by any process that can be a leader itself and that notices that the leader doesn't respond. The process will then send a multicast message stating that an election has begun. If there is no other responding process with a higher pid (process ID) than this process, then this process calls itself the new leader and will broadcast this to all members. If a process with a higher pid responds, then this new process will start to broadcast an election. Furthermore, if a process notes that another process with a lower number calls itself the leader, then it will also start new elections to bully the process with lower pid out of the leader position. Our project contains a link between socket addresses and pid's. This allows us to be sure that every process has a unique pid and thus that the bully algorithm succeeds. Leader election occurs at certain events:
\begin{itemize}
 \item \textbf{Picking a new leader in a group:} When the leader of a group fails, a new one has to be chosen.\\
 \item \textbf{Picking a new lead broker:} There is one lead broker that communicates the energy price to all other brokers. It is thus of vital importance that there is such a leader. A new leader will be chosen among the available brokers by using the bully algorithm.\\
\end{itemize}




main solution
algorithms
IP multicast
bully algorithm


\section{Results}

technical implementation
Fault tolerance

 
\end{document}
